version: 2.1

#Repeatable Python Executor
executors:
  python-executor:
    docker:
      - image: cimg/python:3.12.0

orbs:
  aws-cli: circleci/aws-cli@5.4.1
#Modular Commands 
commands:
  setup-uv:
    description: "Installs and configures uv - our package manager"
    steps:
      - run: 
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
  
  install-dependencies:
    description: "Use UV to install the dependencies"
    steps:
      - run:
          name: Sync dependencies
          command: uv sync --all-packages
  aws-setup:
    description: "Set up AWS CLI with the provided credentials"
    steps:
      - aws-cli/setup:
          role_arn: ${AWS_ROLE_ARN}
          region: ${AWS_REGION}
          role_session_name: "ospsd-session"
          session_duration: "1800"

jobs:
  lint:
    executor: python-executor
    steps:
      - checkout
      - setup-uv
      - install-dependencies
      - run: 
          name: Ruff Check
          command: |
            uv run ruff check 
      - run:
          name: Ruff — format check
          command: uv run ruff format --check .
      - run:
          name: Mypy — strict type checking
          command: uv run mypy --strict .
  
  unit-tests:
    executor: python-executor
    steps:
      - checkout
      - setup-uv
      - install-dependencies
      - run:
          name: Run unit tests with coverage
          command: |
            uv run pytest \
              src/aws_client_impl/tests/unit \
              --junitxml=test-results/unit/results.xml \
              --cov=src \
              --cov-report=xml:coverage/unit-coverage.xml \
              --cov-report=html:coverage/unit-html \
              -v
      - store_test_results:
          path: test-results/unit
      - store_artifacts:
          path: coverage/unit-html
          destination: coverage/unit
  integration-tests:
    executor: python-executor
    steps:
      - checkout
      - setup-uv
      - install-dependencies
      - run:
            name: Run integration tests (DI wiring verification)
            command: |
              uv run pytest \
                tests/integration \
                --junitxml=test-results/integration/results.xml \
                --cov=src \
                --cov-report=xml:coverage/integration-coverage.xml \
                --cov-report=html:coverage/integration-html \
                -v
      - store_test_results:
          path: test-results/integration
      - store_artifacts:
          path: coverage/integration-html
          destination: coverage/integration

  # e2e-tests:
  #   executor: python-executor
  #   steps:
  #     - checkout
  #     - setup-uv
  #     - install-dependencies
  #     - aws-setup
  #     - run:
  #         name: Run E2E tests against real AWS infrastructure
  #         command: |
  #           uv run pytest \
  #             tests/e2e \
  #             --junitxml=test-results/e2e/results.xml \
  #             -v
  #         environment:
  #           AWS_REGION: ${AWS_REGION}
  #           AWS_BUCKET_NAME: ${AWS_BUCKET_NAME}
  #     - store_test_results:
  #         path: test-results/
          
  docs-build:
    executor: python-executor
    steps:
      - checkout
      - setup-uv
      - install-dependencies
      - run:
          name: Build MkDocs documentation
          command: uv run mkdocs build --strict
      - store_artifacts:
          path: site
          destination: docs
          
workflows:
  version: 2
  main:
    jobs:
      - lint
      - docs-build
      - unit-tests
      - integration-tests
      
